<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FandomEntryPass – Ticket Exchange (PWA)</title>

  <!-- App / PWA -->
  <meta name="theme-color" content="#4face7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="robots" content="noindex,nofollow">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="icon-192.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;700&family=Nunito:wght@400;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com" defer></script>

  <!-- ✅ Config must load before app scripts -->
  <script src="config.js"></script>

  <!-- EmailJS + Stripe -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js" defer></script>
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    html, body { font-family: Nunito, ui-sans-serif, system-ui; background:#f7f7f8; }
    .gradient-brand { background: linear-gradient(90deg, #f9a8d4, #93c5fd, #86efac); }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,.70); }
    .badge-step, .chip { font-size: 11px; }
    .ios-safe { padding-bottom: constant(safe-area-inset-bottom); padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body class="min-h-screen ios-safe">

  <!-- Header -->
  <header class="gradient-brand text-white">
    <div class="max-w-6xl mx-auto px-4 py-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="icon-192.png" alt="FEP" class="w-10 h-10 rounded-2xl bg-white/20 p-1">
        <div>
          <h1 class="font-poppins text-2xl leading-none">FandomEntryPass</h1>
          <p class="text-white/90 text-sm -mt-0.5">PWA • Verified Ticket Exchange • MVP</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="openAdd" class="hidden sm:inline-flex bg-white text-sky-700 font-semibold px-4 py-2 rounded-xl shadow hover:bg-white/90">+ Add Listing</button>
        <button id="openManageByCode" class="hidden sm:inline-flex bg-white/20 text-white font-semibold px-4 py-2 rounded-xl shadow hover:bg-white/30">Manage</button>

        <!-- SELLER: entry point button -->
        <button id="openSeller" class="hidden sm:inline-flex bg-white/20 text-white font-semibold px-4 py-2 rounded-xl shadow hover:bg-white/30">Seller</button>

        <button id="installBtn" class="hidden sm:inline-flex bg-white/20 text-white font-semibold px-4 py-2 rounded-xl shadow hover:bg-white/30">Install App</button>
      </div>
    </div>
  </header>

  <!-- Buyer Protection Banner -->
  <section class="max-w-6xl mx-auto px-4 mt-4">
    <div class="rounded-2xl border border-emerald-200 bg-emerald-50 p-4 text-emerald-900 text-sm">
      <div class="flex flex-wrap items-center gap-2">
        <span class="inline-flex items-center gap-1 bg-white/70 px-2 py-1 rounded-full border border-emerald-200 badge-step">1) Buyer pays → <strong>Authorized</strong></span>
        <span class="inline-flex items-center gap-1 bg-white/70 px-2 py-1 rounded-full border border-emerald-200 badge-step">2) Webhook marks <strong>Authorized</strong></span>
        <span class="inline-flex items-center gap-1 bg-white/70 px-2 py-1 rounded-full border border-emerald-200 badge-step">3) Buyer confirms → <strong>Release</strong></span>
        <span class="inline-flex items-center gap-1 bg-white/70 px-2 py-1 rounded-full border border-emerald-200 badge-step">⏱ Auto-release after <strong>72h</strong></span>
      </div>
      <p class="mt-2 text-[13px]">
        App is installable (PWA) and works offline for the main UI. Live payments require your backend & env vars on Vercel.
      </p>
    </div>
  </section>

  <!-- Access code gate -->
  <section class="max-w-6xl mx-auto px-4 mt-3">
    <div id="gate" class="rounded-2xl border border-sky-200 bg-white p-4 text-sky-900 text-sm hidden">
      <div class="flex items-center gap-2">
        <span class="font-poppins">Tester Access</span>
      </div>
      <div class="mt-2 flex gap-2">
        <input id="gateCode" placeholder="Enter access code" class="flex-1 rounded-xl border border-sky-200 px-3 py-2">
        <button id="gateBtn" class="rounded-xl bg-sky-600 text-white px-4 py-2">Unlock</button>
      </div>
      <p class="mt-2 text-xs text-gray-500">Add Listing is hidden until unlocked. Code persists on this device.</p>
    </div>
  </section>

  <!-- Search / Filters -->
  <section class="max-w-6xl mx-auto px-4 py-6">
    <div class="rounded-3xl gradient-brand p-[1px] shadow-lg">
      <div class="glass rounded-3xl p-5 sm:p-6">
        <form id="filters" class="flex flex-col sm:flex-row sm:items-end gap-3">
          <div class="sm:flex-1">
            <label class="text-sm text-gray-600">Search</label>
            <input id="q" placeholder="Group, city, venue…" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 outline-none ring-1 ring-gray-200 focus:ring-sky-300" />
          </div>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:w-auto">
            <div>
              <label class="text-sm text-gray-600">City</label>
              <input id="city" placeholder="Atlanta" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 outline-none ring-1 ring-gray-200 focus:ring-sky-300" />
            </div>
            <div>
              <label class="text-sm text-gray-600">Max Price</label>
              <input id="maxPrice" type="number" min="0" step="1" placeholder="150" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 outline-none ring-1 ring-gray-200 focus:ring-sky-300" />
            </div>
            <div class="flex items-end gap-2">
              <button type="submit" class="w-full rounded-2xl bg-gray-900 text-white px-4 py-3 hover:bg-gray-800">Filter</button>
              <button type="button" id="clearFilters" class="w-full rounded-2xl bg-white text-gray-700 px-4 py-3 ring-1 ring-gray-200 hover:bg-gray-50">Clear</button>
            </div>
          </div>
        </form>
        <div class="mt-3 text-xs text-gray-600">
          Safety: buyer funds are held until transfer is confirmed (simulated until Stripe backend is live). Listings must stay within
          <strong>+15% of face value</strong>. Proof of ticket is required (emailed to admin).
        </div>
      </div>
    </div>
  </section>

  <!-- Listings -->
  <main class="max-w-6xl mx-auto px-4 pb-24">
    <div id="listings" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    <div id="emptyState" class="hidden text-center text-gray-500 mt-10">No listings match your filters (yet!).</div>
  </main>

  <!-- Mobile FAB -->
  <div class="fixed bottom-5 right-5 flex flex-col gap-2 sm:hidden">
    <button id="openAddFab" class="gradient-brand text-white px-5 py-3 rounded-2xl shadow-xl">+ Add Listing</button>
    <button id="openManageByCodeFab" class="bg-gray-900 text-white px-5 py-3 rounded-2xl shadow-xl">Manage</button>
  </div>

  <!-- Add Listing Modal -->
  <section id="modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-end sm:items-center justify-center p-3">
      <div class="w-full sm:w-[860px] bg-white rounded-3xl shadow-2xl overflow-hidden">
        <div class="gradient-brand p-5 text-white">
          <h3 class="font-poppins text-xl">Add a Listing</h3>
          <p class="text-white/90 text-sm">Blur barcodes on proof images. Above +15% is blocked. Seller email and phone are required for notifications.</p>
        </div>
        <form id="addForm" class="p-5 grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="sm:col-span-2">
            <label class="text-sm text-gray-600">Group / Show <span class="text-rose-500">*</span></label>
            <input name="group" required placeholder="ATEEZ – Atlanta Day 1" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 ring-1 ring-gray-200 focus:ring-sky-300 outline-none" />
          </div>
          <div>
            <label class="text-sm text-gray-600">Quantity <span class="text-rose-500">*</span></label>
            <input name="qty" type="number" min="1" step="1" required placeholder="1" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 ring-1 ring-gray-200 focus:ring-sky-300 outline-none" />
          </div>
          <div>
            <label class="text-sm text-gray-600">Date & Venue <span class="text-rose-500">*</span></label>
            <input name="date" required placeholder="Nov 12, 2025 • Gas South Arena" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 ring-1 ring-gray-200 focus:ring-sky-300 outline-none" />
          </div>
          <div>
            <label class="text-sm text-gray-600">City</label>
            <input name="city" placeholder="Atlanta" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 ring-1 ring-gray-200 focus:ring-sky-300 outline-none" />
          </div>
          <div class="sm:col-span-2">
            <label class="text-sm text-gray-600">Section / Row / Seat</label>
            <input name="seat" placeholder="Sec 104 • Row F • Seat 12" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 ring-1 ring-gray-200 focus:ring-sky-300 outline-none" />
          </div>
          <div>
            <label class="text-sm text-gray-600">Face Value (USD) <span class="text-rose-500">*</span></label>
            <input name="face" type="number" min="1" step="1" required placeholder="100" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 ring-1 ring-gray-200 focus:ring-sky-300 outline-none" />
          </div>
          <div>
            <label class="text-sm text-gray-600">Your Price (USD) <span class="text-rose-500">*</span></label>
            <input name="price" type="number" min="1" step="1" required placeholder="110" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 ring-1 ring-gray-200 focus:ring-sky-300 outline-none" />
            <p class="text-xs text-gray-500 mt-1">We auto-check the +15% cap. Above-cap listings are blocked.</p>
          </div>
          <div class="sm:col-span-3">
            <label class="text-sm text-gray-600">Proof of Ticket (image) <span class="text-rose-500">*</span></label>
            <input name="proof" type="file" accept="image/*" required class="w-full mt-1 rounded-2xl bg-white px-4 py-3 ring-1 ring-gray-200" />
            <p class="text-xs text-gray-500 mt-1">Proof is required and will be emailed to admin (not stored on the site).</p>
          </div>
          <div class="sm:col-span-2">
            <label class="text-sm text-gray-600">Payment Link (Stripe/PayPal/etc.) <span class="text-rose-500">*</span></label>
            <input name="pay" required placeholder="https://buy.stripe.com/... (Payment Link)" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 ring-1 ring-gray-200 focus:ring-sky-300 outline-none" />
          </div>
          <div>
            <label class="text-sm text-gray-600">Seller Name</label>
            <input name="seller" placeholder="Mina" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 ring-1 ring-gray-200 focus:ring-sky-300 outline-none" />
          </div>
          <div class="sm:col-span-3">
            <label class="text-sm text-gray-600">Seller Phone (required)</label>
            <input name="sellerPhone" type="tel" required placeholder="555-123-4567" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 ring-1 ring-gray-200 outline-none" />
          </div>
          <div class="sm:col-span-3">
            <label class="text-sm text-gray-600">Seller Email (required)</label>
            <input name="sellerEmail" type="email" required placeholder="you@example.com" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 ring-1 ring-gray-200 outline-none" />
          </div>
          <div class="sm:col-span-3 flex items-center gap-2 mt-2">
            <input id="agree" type="checkbox" required class="w-4 h-4" />
            <label for="agree" class="text-sm text-gray-700">I agree to fair-pricing rules (+15% cap) and safe transfer.</label>
          </div>
          <div class="sm:col-span-3 flex items-center justify-end gap-3 pt-2">
            <button type="button" id="cancelAdd" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200">Cancel</button>
            <button class="px-5 py-2 rounded-xl text-white gradient-brand hover:opacity-90">Add Listing</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- SELLER LOGIN (email code) -->
  <section id="sellerLoginModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-end sm:items-center justify-center p-3">
      <div class="w-full sm:w-[480px] bg-white rounded-3xl shadow-2xl overflow-hidden">
        <div class="gradient-brand p-5 text-white">
          <h3 class="font-poppins text-xl">Seller Login</h3>
          <p class="text-white/90 text-sm">We’ll email you a 6-digit code to confirm it’s you.</p>
        </div>
        <div class="p-5 space-y-4">
          <div id="sellerStepEmail">
            <label class="text-sm text-gray-600">Email</label>
            <input id="sellerLoginEmail" type="email" placeholder="you@example.com" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 ring-1 ring-gray-200 focus:ring-sky-300 outline-none" />
            <button id="sendLoginCodeBtn" class="mt-3 w-full rounded-2xl bg-gray-900 text-white px-4 py-3 hover:bg-gray-800">Send code</button>
          </div>

          <div id="sellerStepCode" class="hidden">
            <label class="text-sm text-gray-600">Enter 6-digit code</label>
            <input id="sellerLoginCode" inputmode="numeric" maxlength="6" placeholder="123456" class="w-full mt-1 rounded-2xl bg-white px-4 py-3 ring-1 ring-gray-200 focus:ring-sky-300 outline-none" />
            <button id="verifyLoginCodeBtn" class="mt-3 w-full rounded-2xl bg-gray-900 text-white px-4 py-3 hover:bg-gray-800">Verify & Sign in</button>
          </div>

          <div class="flex items-center justify-end gap-3 pt-2">
            <button id="closeSellerLogin" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200">Close</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SELLER: Dashboard modal/section -->
  <section id="sellerDash" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-end sm:items-center justify-center p-3">
      <div class="w-full sm:w-[920px] bg-white rounded-3xl shadow-2xl overflow-hidden">
        <div class="gradient-brand p-5 text-white">
          <h3 class="font-poppins text-xl">Seller Dashboard</h3>
          <p class="text-white/90 text-sm">Manage your Stripe connection and listings.</p>
        </div>

        <div class="p-5 grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Seller Identity -->
          <div class="md:col-span-3 rounded-2xl border border-gray-200 p-4">
            <label class="text-sm text-gray-600">Seller Email (for your listings)</label>
            <div class="mt-1 flex gap-2">
              <input id="sellerEmailInput" placeholder="you@example.com"
                     class="flex-1 rounded-xl bg-white px-4 py-3 ring-1 ring-gray-200 focus:ring-sky-300 outline-none" />
              <button id="saveSellerEmail" class="rounded-xl bg-gray-900 text-white px-4">Save</button>
            </div>
            <p class="text-xs text-gray-500 mt-1">We match your listings by this email (no buyer account required).</p>
          </div>

          <!-- Stripe Connect Card -->
          <div class="md:col-span-3 rounded-2xl border border-gray-200 p-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm text-gray-600">Stripe Status</div>
                <div id="stripeStatus" class="text-base font-semibold">Not connected</div>
                <div id="stripeAcct" class="text-xs text-gray-500"></div>
              </div>
              <div class="flex gap-2">
                <button id="connectStripe" class="rounded-xl bg-indigo-600 text-white px-4 py-2">Connect Stripe</button>
                <button id="reconnectStripe" class="rounded-xl bg-indigo-50 text-indigo-700 px-4 py-2 ring-1 ring-indigo-200 hidden">
                  Reconnect
                </button>
              </div>
            </div>
          </div>

          <!-- My Listings -->
          <div class="md:col-span-3 rounded-2xl border border-gray-200 p-4">
            <div class="flex items-center justify-between">
              <h4 class="font-poppins text-lg">My Listings</h4>
              <button id="refreshListings" class="rounded-xl bg-gray-100 px-3 py-2 hover:bg-gray-200">Refresh</button>
            </div>
            <div id="myListings" class="mt-3 grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="noListings" class="hidden text-sm text-gray-500 mt-2">No listings found for this email.</div>
          </div>

          <!-- ✅ NEW Orders (this device) panel -->
          <div class="md:col-span-3 rounded-2xl border border-gray-200 p-4">
            <div class="flex items-center justify-between">
              <h4 class="font-poppins text-lg">Orders (this device)</h4>
              <button id="refreshOrders" class="rounded-xl bg-gray-100 px-3 py-2 hover:bg-gray-200">Refresh</button>
            </div>
            <p class="text-xs text-gray-500 mt-1">These Checkout Sessions were saved on this device after a successful redirect.</p>
            <div id="myOrders" class="mt-3 grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="noOrders" class="hidden text-sm text-gray-500 mt-2">No orders saved yet.</div>
          </div>
          <!-- /NEW Orders panel -->

          <!-- Escrow status tool (manual check) -->
          <div class="md:col-span-3 rounded-2xl border border-gray-200 p-4">
            <h4 class="font-poppins text-lg">Check an Order (optional)</h4>
            <p class="text-xs text-gray-500">Paste a Stripe Checkout Session ID to see escrow status.</p>
            <div class="mt-2 flex gap-2">
              <input id="sidInput" placeholder="cs_live_..."
                     class="flex-1 rounded-xl bg-white px-4 py-3 ring-1 ring-gray-200 focus:ring-sky-300 outline-none" />
              <button id="checkSid" class="rounded-xl bg-gray-900 text-white px-4">Check</button>
            </div>
            <pre id="sidResult" class="mt-2 text-xs bg-gray-50 p-2 rounded-xl overflow-auto"></pre>
          </div>

          <div class="md:col-span-3 flex justify-end gap-2">
            <button id="closeSeller" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200">Close</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="mt-10 py-10 text-center text-sm text-gray-500">
    <p>FandomEntryPass • Installable PWA • Fan-first, fair pricing. Buyer and seller contact required; data purged after payout.</p>
  </footer>

  <script>
    /* ===========================
       CONFIG (frontend) + globals
       =========================== */
    const {
      STRIPE_PK,
      FORMSPREE = "https://formspree.io/f/mvgqedqo",
      EMAILJS_PUBLIC = "",
      EMAILJS_SERVICE = "",
      EMAILJS_TPL_BUYER = "",
      EMAILJS_TPL_SELLER = "",
      EMAILJS_TPL_LOGIN = "",      // ⬅️ optional, if you make a dedicated login template
      ESCROW_HOURS = 72
    } = (window.APP_CONFIG || {});

    const ORIGIN = (window.APP_CONFIG?.API_BASE || window.location.origin).replace(/\/+$/, "");
    if (!STRIPE_PK) console.warn("⚠️ Missing STRIPE_PK in config.js (Production must use pk_live_...)");

    let stripe = Stripe(STRIPE_PK);

    /* ===========================
       PWA install + Service Worker
       =========================== */
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
      });
    }
    let deferredPrompt=null;
    window.addEventListener("beforeinstallprompt",(e)=>{
      e.preventDefault(); deferredPrompt=e;
      const btn = document.getElementById("installBtn"); if(btn) btn.classList.remove("hidden");
    });
    document.getElementById("installBtn")?.addEventListener("click", async ()=>{
      if(!deferredPrompt) return; deferredPrompt.prompt();
      await deferredPrompt.userChoice; deferredPrompt=null;
      const btn = document.getElementById("installBtn"); if(btn) btn.classList.add("hidden");
    });

    /* ===========================
       Access Gate
       =========================== */
    const ACCESS_KEY = "fep_gate_ok";
    const ACCESS_CODE = "FEPTEST";
    function gateCheck(){
      const ok = localStorage.getItem(ACCESS_KEY)==="1";
      const show = v => {
        ["openAdd","openAddFab"].forEach(id=>{
          const el=document.getElementById(id); if(el) el.style.display = v ? "" : "none";
        });
      };
      const gate = document.getElementById("gate");
      if(!gate) return;
      if(ok){ gate.classList.add("hidden"); show(true); }
      else  { gate.classList.remove("hidden"); show(false); }
    }
    document.getElementById("gateBtn")?.addEventListener("click", ()=>{
      const input = document.getElementById("gateCode");
      const code = (input?.value || "").trim().toUpperCase();
      if(code===ACCESS_CODE){ localStorage.setItem(ACCESS_KEY,"1"); gateCheck(); }
      else alert("Wrong code");
    });

    /* ===========================
       Storage + Helpers
       =========================== */
    const KEY = "fep_listings_v1";
    function load(){ try{ return JSON.parse(localStorage.getItem(KEY) || "[]") }catch{ return [] } }
    function save(list){ localStorage.setItem(KEY, JSON.stringify(list)) }
    const money = n => "$"+Number(n).toFixed(0);
    const capFor = face => Math.round(Number(face)*1.15);
    const withinCap = (face, price) => Number(price) <= capFor(face) + 0.0001;
    const hoursMs = h => h*60*60*1000;
    const token = () => Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2);
    const esc = s => String(s ?? "").replace(/[&<>"'`=\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&#x3E;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c]));

    /* ===========================
       Formspree (attachment) with Resend fallback
       =========================== */
    async function sendProofViaFormspree(listing, proofFile){
      const fd = new FormData();
      fd.append("_subject", "FEP: New Listing Proof of Ticket");
      fd.append("message",
        `New listing submitted with proof:\n\n`+
        `Group: ${listing.group}\n`+
        `Date & Venue: ${listing.date}\n`+
        `City: ${listing.city}\n`+
        `Seat: ${listing.seat}\n`+
        `Face: $${listing.face}\n`+
        `Price: $${listing.price}\n`+
        `Qty: ${listing.qty}\n`+
        `Seller: ${listing.seller} <${listing.sellerEmail}> (${listing.sellerPhone})`
      );
      if (listing.sellerEmail) fd.append("_replyto", listing.sellerEmail);
      fd.append("attachment", proofFile);

      // include structured fields so the fallback email includes all details too
      fd.append("listingId", listing.id || "");
      fd.append("group", listing.group || "");
      fd.append("date", listing.date || "");
      fd.append("city", listing.city || "");
      fd.append("seat", listing.seat || "");
      fd.append("face", String(listing.face ?? ""));
      fd.append("price", String(listing.price ?? ""));
      fd.append("qty", String(listing.qty ?? ""));
      fd.append("seller", listing.seller || "");
      fd.append("sellerEmail", listing.sellerEmail || "");
      fd.append("sellerPhone", listing.sellerPhone || "");

      // UI status
      const status = document.createElement("div");
      status.textContent = "Sending proof...";
      Object.assign(status.style, { position:"fixed", bottom:"12px", left:"12px", padding:"8px 10px", background:"#000", color:"#fff", borderRadius:"10px", fontSize:"12px", zIndex:"99999" });
      document.body.appendChild(status);

      const ORIGIN2 = (window.APP_CONFIG?.API_BASE || window.location.origin).replace(/\/+$/,'');

      try {
        // 1) Try Formspree
        const res = await fetch(FORMSPREE, { method: "POST", headers: { "Accept":"application/json" }, body: fd });
        const data = await res.json().catch(() => ({}));
        const ok = res.ok && !data?.error && !((data?.errors || []).length);
        if (ok) {
          status.textContent = "Proof sent!";
          setTimeout(() => status.remove(), 2500);
          return true;
        }
        throw new Error(data?.error || (data?.errors||[]).map(e=>e.message).join(", ") || res.statusText);
      } catch (e) {
        console.warn("Formspree failed, using fallback:", e.message);
        try {
          // 2) Fallback → your Vercel API (emails via Resend)
          const r = await fetch(`${ORIGIN2}/api/proof-fallback`, { method: "POST", body: fd });
          if (!r.ok) {
            const t = await r.text().catch(()=> "");
            throw new Error(t || r.statusText);
          }
          status.textContent = "Proof sent (fallback)!";
          setTimeout(() => status.remove(), 2500);
          return true;
        } catch (e2) {
          console.error("Fallback also failed:", e2);
          status.textContent = "Upload failed";
          setTimeout(() => status.remove(), 2500);
          alert("Could not send proof. Please email support with your screenshot.");
          return false;
        }
      }
    }

    /* ===========================
       Email notifications (unified)
       =========================== */
    try { if (EMAILJS_PUBLIC) emailjs.init(EMAILJS_PUBLIC); } catch {}

    function sendNotify(to_email, vars = {}) {
      if (!to_email || !EMAILJS_SERVICE || !EMAILJS_TPL_SELLER) return;
      try { return emailjs.send(EMAILJS_SERVICE, EMAILJS_TPL_SELLER, { to_email, ...vars }); } catch (e) {}
    }
    const sellerNotify = (email, vars = {}) => sendNotify(email, { purpose: "seller", ...vars });
    const buyerNotify  = (email, vars = {}) => sendNotify(email, { purpose: "buyer",  ...vars });
    async function sendLoginCodeEmail(email, code) {
      const templateId = EMAILJS_TPL_LOGIN || EMAILJS_TPL_SELLER;
      if (!templateId || !EMAILJS_SERVICE) throw new Error("EmailJS template/service missing");
      return emailjs.send(EMAILJS_SERVICE, templateId, { to_email: email, code, purpose: "login" });
    }

    /* ===========================
       Render Listings (escaped)
       =========================== */
    const elListings=document.getElementById("listings"), elEmpty=document.getElementById("emptyState");
    function render(list=load()){
      elListings.textContent="";
      if(!list.length){ elEmpty?.classList.remove("hidden"); return; }
      elEmpty?.classList.add("hidden");
      for(const it of list){
        const ok = withinCap(it.face, it.price);
        const cap = capFor(it.face);
        const remaining = (it.remaining ?? it.qty);
        const card=document.createElement("article");
        card.className="rounded-3xl border border-gray-200 p-4 bg-white shadow-sm hover:shadow-md transition-shadow";

        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="font-poppins text-lg">${esc(it.group)}</h3>
              <p class="text-xs text-gray-500 mt-0.5">${esc(it.city ? `${it.date} • ${it.city}` : it.date)}</p>
              <p class="text-xs text-gray-600 mt-1">${esc(it.seat||"")}</p>
              <div class="mt-2 flex items-center gap-2">
                <span class="chip inline-flex items-center gap-1 bg-gray-100 px-2 py-1 rounded-full">Face: ${money(it.face)}</span>
                <span class="chip inline-flex items-center gap-1 bg-gray-100 px-2 py-1 rounded-full">Cap: ${money(cap)}</span>
                <span class="chip inline-flex items-center gap-1 ${remaining>0?"bg-emerald-100":"bg-gray-200"} px-2 py-1 rounded-full">Available: ${(remaining)}/${it.qty}</span>
              </div>
            </div>
          </div>
          <div class="flex items-center justify-between mt-3">
            <div>
              <div class="text-xl font-poppins ${ok?"text-gray-900":"text-rose-600"}">${money(it.price)}</div>
            </div>
            <button data-buy="${esc(it.id)}" ${ remaining > 0 ? "" : "disabled" }
              class="rounded-xl px-4 py-2 text-white ${ remaining > 0 ? "gradient-brand hover:opacity-90" : "bg-gray-400" }">
              ${ remaining > 0 ? "Buy Safely" : "Sold Out" }
            </button>
          </div>
          ${ ok ? "" : `<div class="mt-3 text-[11px] text-rose-600">⚠️ This price exceeds the +15% cap and will be blocked.</div>` }
          <div class="mt-2 text-[11px] text-gray-500">Funds held until transfer is confirmed. Report issues to <a class="underline" href="mailto:support@fandomentrypass.com">support</a>.</div>
        `;
        elListings.appendChild(card);
      }
      document.querySelectorAll("[data-buy]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-buy");
          startBuy(id);
        });
      });
    }

    /* ===========================
       Filters
       =========================== */
    function applyFilters(evt){
      if(evt) evt.preventDefault();
      const q = document.getElementById("q").value.trim().toLowerCase();
      const city = document.getElementById("city").value.trim().toLowerCase();
      const maxPrice = Number(document.getElementById("maxPrice").value || Infinity);
      const list = load().filter(it=>{
        const hay=(String(it.group)+" "+String(it.date)+" "+String(it.city||"")).toLowerCase();
        const matchQ=!q || hay.includes(q);
        const matchCity=!city || String(it.city||"").toLowerCase().includes(city);
        const matchPrice=!isFinite(maxPrice) || Number(it.price) <= maxPrice;
        return matchQ && matchCity && matchPrice;
      });
      render(list);
    }
    document.getElementById("filters").addEventListener("submit", applyFilters);
    document.getElementById("clearFilters").addEventListener("click", ()=>{
      document.getElementById("q").value=""; document.getElementById("city").value=""; document.getElementById("maxPrice").value="";
      applyFilters();
    });

    /* ===========================
       Modals
       =========================== */
    const modal = document.getElementById("modal");
    const openModal = ()=> modal?.classList.remove("hidden");
    const closeModal = ()=> modal?.classList.add("hidden");
    document.getElementById("openAdd")?.addEventListener("click", openModal);
    document.getElementById("openAddFab")?.addEventListener("click", openModal);
    document.getElementById("cancelAdd")?.addEventListener("click", closeModal);

    document.getElementById("openManageByCode")?.addEventListener("click", promptManageByCode);
    document.getElementById("openManageByCodeFab")?.addEventListener("click", promptManageByCode);

    function promptManageByCode(){
      const code=prompt("Enter your 10-character manage code:"); if(!code) return;
      const list=load();
      const it=list.find(x => (x.manageCode||"").slice(0,10) === code.trim().toUpperCase());
      if(!it) return alert("No listing found for that code.");
      alert("Editing from phone not yet enabled in this build. (Coming soon)");
    }

    /* ===========================
       Add Listing
       =========================== */
    document.getElementById("addForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const face=Number(fd.get("face"));
      const price=Number(fd.get("price"));
      const qty=Math.max(1, Number(fd.get("qty")||1));
      if(!withinCap(face,price)) return alert("This price exceeds the +15% cap. Please lower the price.");
      const proofFile=fd.get("proof");
      if(!proofFile || !proofFile.size) return alert("Proof of ticket is required. Please upload your proof image.");

      const sellerEmail=String(fd.get("sellerEmail")||"").trim();
      const sellerPhone=String(fd.get("sellerPhone")||"").trim();
      if(!sellerEmail || !sellerPhone) return alert("Seller email and phone are required for notifications.");

      const editToken = token();
      const manageCode = editToken.slice(0,10).toUpperCase();

      const sellerAccountId = localStorage.getItem("fep_connect_acct") || ""; // ⬅️ use connected acct if present

      const listing = {
        id: crypto.randomUUID(),
        group: String(fd.get("group")||"").trim(),
        date: String(fd.get("date")||"").trim(),
        city: String(fd.get("city")||"").trim(),
        seat: String(fd.get("seat")||"").trim(),
        face, price, qty,
        remaining: qty,
        pay: String(fd.get("pay")||"").trim(),
        seller: String(fd.get("seller")||"Seller").trim(),
        sellerEmail, sellerPhone,
        sellerAccountId,             // ⬅️ ensure it’s stored on the listing
        editToken, manageCode
      };

      // email proof (attachment) to admin
      await sendProofViaFormspree(listing, proofFile);

      // save locally (until backend moderation is live)
      const list=load(); list.unshift(listing); save(list);

      try{
        const manageUrl = `${location.origin}${location.pathname}?manage=${editToken}`;
        await navigator.clipboard.writeText(manageUrl);
        alert(`Listing created!\n\nSeller manage code: ${manageCode}\n(Manage link copied to clipboard.)`);
      }catch{
        alert(`Listing created!\n\nSeller manage code: ${manageCode}`);
      }

      closeModal(); e.target.reset(); applyFilters(); window.scrollTo({ top:0, behavior:"smooth" });
    });

    /* ===========================
       Buy → Backend (Stripe Checkout) with fallback sim
       =========================== */
    async function startBuy(listingId){
      const list = load();
      const it = list.find(x => x.id === listingId);
      if (!it) return;
      if ((it.remaining ?? it.qty) <= 0) {
        alert("Sorry, this listing is sold out.");
        return;
      }

      // Optional: ask buyer email (for notifications)
      const buyerEmail = prompt("Enter your email for updates (optional):") || "";

      // Pull a seller account if present (from listing or localStorage)
      const sellerAccountId = it.sellerAccountId || localStorage.getItem("fep_connect_acct") || "";

      // Safety: if Stripe didn’t init, bail before calling backend
      if (!window.stripe) {
        alert("Payments aren’t ready yet. Please try again later.");
        return;
      }

      // Call your backend to create a Checkout Session.
      try {
        const res = await fetch(`${ORIGIN}/api/create-checkout-session`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            listingId: it.id,
            group: it.group, date: it.date, city: it.city, seat: it.seat,
            face: it.face, price: it.price, qty: 1,
            sellerEmail: it.sellerEmail, buyerEmail,
            sellerAccountId  // pass through to backend
          })
        });
        if (!res.ok) {
          const errText = await res.text();
          console.error("Checkout session HTTP error", res.status, errText);
          throw new Error(errText || `HTTP ${res.status}`);
        }
        const data = await res.json();
        if (data.sessionId) {
          await stripe.redirectToCheckout({ sessionId: data.sessionId });
          return;
        }
      } catch (e) {
        console.error("Checkout session request failed", e);
        console.warn("Backend not ready, falling back to demo auth:", e.message);
      }

      // ---- Fallback simulation (authorized → auto-release in 72h) ----
      it.remaining = Math.max(0, (it.remaining ?? it.qty ?? 1) - 1);
      it.orders = it.orders || [];
      it.orders.push({
        id: crypto.randomUUID(),
        status: "authorized",
        authorizedAt: Date.now(),
        buyerEmail,
        token: token(),
        tokenExpiresAt: Date.now() + hoursMs(ESCROW_HOURS)
      });
      save(list); render(list);
      buyerNotify(buyerEmail, { group: it.group, price: money(it.price) });
      sellerNotify(it.sellerEmail, { group: it.group, price: money(it.price) });
      alert("Payment authorized (demo). Funds auto-release in 72h unless buyer confirms received earlier.");
    }

    /* ===========================
       Auto-release + Privacy purge (demo)
       =========================== */
    const RETENTION_MS = 7*24*3600*1000;
    function tick(){
      const list=load(); let changed=false; const now=Date.now();
      for(const it of list){
        for(const o of (it.orders||[])){
          if(o.status==="authorized" && o.tokenExpiresAt && now>o.tokenExpiresAt){
            o.status="released"; o.releasedAt=Date.now(); changed=true;
          }
          if(o.releasedAt && now-o.releasedAt>RETENTION_MS && !o.purged){
            delete o.buyerEmail; o.purged=true; changed=true;
          }
        }
      }
      if(changed) save(list);
    }
    setInterval(tick, 30000);

    /* ===========================
       BUYER ESCROW BANNER
       =========================== */
    (async function escrowBanner() {
      const params = new URLSearchParams(location.search);
      const sid = params.get("sid");
      const success = params.get("success");
      if (!success || !sid) return;

      try {
        const resp = await fetch(`${ORIGIN}/api/session-status?sid=${encodeURIComponent(sid)}`);
        const data = await resp.json();
        if (!data?.ok) return;

        <!-- ✅ NEW: Save successful session id so seller dashboard can show it -->
        addOrderSid(sid);

        const container = document.createElement("div");
        container.className = "fixed bottom-0 inset-x-0 z-50 bg-emerald-50 border-t border-emerald-200 p-4";
        container.innerHTML = `
          <div class="max-w-4xl mx-auto flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div>
              <div class="font-semibold text-emerald-800">Payment authorized. Funds are in escrow.</div>
              <div class="text-sm text-emerald-700">
                Please confirm after you receive your ticket. Auto-capture in <span id="fepCountdown" class="font-semibold"></span>.
              </div>
            </div>
            <div class="flex gap-2">
              <button id="fepConfirm" class="px-4 py-2 rounded-xl bg-emerald-600 text-white">Confirm received</button>
              <button id="fepIssue" class="px-4 py-2 rounded-xl bg-rose-600 text-white">Report a problem</button>
            </div>
          </div>
        `;
        document.body.appendChild(container);

        // Countdown
        const el = container.querySelector("#fepCountdown");
        function tickDown() {
          const now = Math.floor(Date.now() / 1000);
          const remain = Math.max(0, (data.deadline || 0) - now);
          const h = Math.floor(remain / 3600);
          const m = Math.floor((remain % 3600) / 60);
          const s = remain % 60;
          el.textContent = `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
        }
        tickDown(); const t = setInterval(tickDown, 1000);

        // Buttons
        container.querySelector("#fepConfirm").onclick = async () => {
          const r = await fetch(`${ORIGIN}/api/confirm-received`, {
            method: "POST", headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ sessionId: sid })
          });
          if (r.ok) { alert("Thanks! Payment captured."); location.href = "/"; }
          else { alert("Capture failed. Please contact support."); }
        };
        container.querySelector("#fepIssue").onclick = async () => {
          const r = await fetch(`${ORIGIN}/api/report-issue`, {
            method: "POST", headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ sessionId: sid })
          });
          if (r.ok) { alert("Issue reported. Authorization canceled."); location.href = "/"; }
          else { alert("Could not cancel. Please contact support."); }
        };
      } catch (e) {
        console.warn("Escrow banner failed:", e);
      }
    })();

    /* ========= SELLER LOGIN (email code) ========= */
    const SELLER_PROFILE_KEY = "fep_seller_profile";   // { email, connectAccountId? }
    const CODE_KEY = "fep_seller_code";
    const CODE_EMAIL_KEY = "fep_seller_code_email";
    const CODE_EXPIRES_KEY = "fep_seller_code_expires";

    function getSellerProfile(){
      try { return JSON.parse(localStorage.getItem(SELLER_PROFILE_KEY) || "null"); } catch { return null; }
    }
    function setSellerProfile(p){ localStorage.setItem(SELLER_PROFILE_KEY, JSON.stringify(p || null)); }

    function genCode(){ return String(Math.floor(100000 + Math.random()*900000)); }
    function storeCode(email, code){
      sessionStorage.setItem(CODE_KEY, code);
      sessionStorage.setItem(CODE_EMAIL_KEY, email);
      sessionStorage.setItem(CODE_EXPIRES_KEY, String(Date.now()+10*60*1000)); // 10 min
    }
    function readCodeState(){
      const code = sessionStorage.getItem(CODE_KEY);
      const email = sessionStorage.getItem(CODE_EMAIL_KEY);
      const exp = Number(sessionStorage.getItem(CODE_EXPIRES_KEY) || 0);
      return { code, email, exp };
    }

    const sellerLoginModal = document.getElementById("sellerLoginModal");
    const openSellerBtn = document.getElementById("openSeller");
    const closeSellerLogin = document.getElementById("closeSellerLogin");
    const sellerStepEmail = document.getElementById("sellerStepEmail");
    const sellerStepCode = document.getElementById("sellerStepCode");
    const sellerLoginEmail = document.getElementById("sellerLoginEmail");
    const sendLoginCodeBtn = document.getElementById("sendLoginCodeBtn");
    const sellerLoginCode = document.getElementById("sellerLoginCode");
    const verifyLoginCodeBtn = document.getElementById("verifyLoginCodeBtn");

    function openSellerLogin(){ sellerLoginModal?.classList.remove("hidden"); showLoginStep("email"); }
    function closeSellerLoginModal(){ sellerLoginModal?.classList.add("hidden"); }
    function showLoginStep(step){
      sellerStepEmail.classList.toggle("hidden", step!=="email");
      sellerStepCode.classList.toggle("hidden", step!=="code");
    }

    closeSellerLogin?.addEventListener("click", closeSellerLoginModal);

    sendLoginCodeBtn?.addEventListener("click", async ()=>{
      const email = (sellerLoginEmail?.value || "").trim();
      if (!email) return alert("Enter your email");
      const code = genCode();
      storeCode(email, code);
      try {
        await sendLoginCodeEmail(email, code);
        showLoginStep("code");
        sellerLoginCode?.focus();
      } catch (e) {
        console.error("EmailJS send failed", e);
        alert("Could not send code. Try again.");
      }
    });

    verifyLoginCodeBtn?.addEventListener("click", ()=>{
      const entered = (sellerLoginCode?.value || "").trim();
      const { code, email, exp } = readCodeState();
      if (!code || !email || !exp || Date.now() > exp) {
        return alert("Code expired. Please request a new one.");
      }
      if (entered !== code) return alert("Incorrect code.");
      const existing = getSellerProfile() || {};
      const acct = localStorage.getItem("fep_connect_acct") || existing.connectAccountId || "";
      setSellerProfile({ email, connectAccountId: acct });
      localStorage.setItem("fep_seller_email", email);
      sessionStorage.removeItem(CODE_KEY);
      sessionStorage.removeItem(CODE_EMAIL_KEY);
      sessionStorage.removeItem(CODE_EXPIRES_KEY);
      closeSellerLoginModal();
      openSellerDash();
    });

    /* ========= SELLER DASHBOARD LOGIC ========= */
    const FEP_ACCT_KEY = "fep_connect_acct";
    const FEP_SELLER_EMAIL_KEY = "fep_seller_email";

    function openSellerDash(){ document.getElementById("sellerDash").classList.remove("hidden"); loadSellerPanel(); }
    function closeSellerDash(){ document.getElementById("sellerDash").classList.add("hidden"); }

    openSellerBtn?.addEventListener("click", ()=>{
      const email = localStorage.getItem(FEP_SELLER_EMAIL_KEY) || "";
      if (!email) openSellerLogin(); else openSellerDash();
    });
    document.getElementById("closeSeller")?.addEventListener("click", closeSellerDash);

    document.getElementById("saveSellerEmail")?.addEventListener("click", ()=>{
      const email = document.getElementById("sellerEmailInput").value.trim();
      if(!email) return alert("Enter a seller email.");
      localStorage.setItem(FEP_SELLER_EMAIL_KEY, email);
      const prof = getSellerProfile() || {};
      setSellerProfile({ email, connectAccountId: prof.connectAccountId || localStorage.getItem(FEP_ACCT_KEY) || "" });
      renderMyListings();
      alert("Saved.");
    });

    async function connectOrReconnectStripe(){
      const sellerEmail = localStorage.getItem(FEP_SELLER_EMAIL_KEY) || document.getElementById("sellerEmailInput").value.trim();
      if(!sellerEmail) return alert("Save your seller email first.");
      const accountId = localStorage.getItem(FEP_ACCT_KEY) || "";
      const sellerName = "";

      const r = await fetch(`${ORIGIN}/api/connect/create-link`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ sellerEmail, sellerName, accountId })
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok || !data?.url) return alert("Could not start Stripe onboarding.");
      if (data.accountId) {
        localStorage.setItem(FEP_ACCT_KEY, data.accountId);
        const prof = getSellerProfile() || {};
        setSellerProfile({ email: prof.email || sellerEmail, connectAccountId: data.accountId });
      }
      location.href = data.url;
    }

    document.getElementById("connectStripe")?.addEventListener("click", connectOrReconnectStripe);
    document.getElementById("reconnectStripe")?.addEventListener("click", connectOrReconnectStripe);
    document.getElementById("refreshListings")?.addEventListener("click", renderMyListings);

    async function loadStripeStatus(){
      const acct = localStorage.getItem(FEP_ACCT_KEY) || "";
      const elStatus = document.getElementById("stripeStatus");
      const elAcct = document.getElementById("stripeAcct");
      const btnReconnect = document.getElementById("reconnectStripe");
      if(!acct){
        elStatus.textContent = "Not connected";
        elAcct.textContent = "";
        btnReconnect.classList.add("hidden");
        return;
      }
      const r = await fetch(`${ORIGIN}/api/connect/account-status?account=${encodeURIComponent(acct)}`);
      const d = await r.json().catch(()=> ({}));
      if(!r.ok || !d?.ok){
        elStatus.textContent = "Unknown";
        elAcct.textContent = `Account: ${acct}`;
        btnReconnect.classList.remove("hidden");
        return;
      }
      const ok = d.charges_enabled && d.payouts_enabled;
      elStatus.textContent = ok ? "Connected" : "Needs info";
      elAcct.textContent = `Account: ${d.account}`;
      if (ok) btnReconnect.classList.add("hidden"); else btnReconnect.classList.remove("hidden");
    }

    function renderMyListings(){
      const email = localStorage.getItem(FEP_SELLER_EMAIL_KEY) || "";
      document.getElementById("sellerEmailInput").value = email;
      const my = (load() || []).filter(x => (x.sellerEmail||"").toLowerCase() === email.toLowerCase());
      const wrap = document.getElementById("myListings");
      const empty = document.getElementById("noListings");
      wrap.textContent = "";
      if(!my.length){ empty.classList.remove("hidden"); return; }
      empty.classList.add("hidden");
      for(const it of my){
        const div = document.createElement("div");
        div.className = "rounded-2xl border border-gray-200 p-3";
        div.innerHTML = `
          <div class="font-semibold">${esc(it.group)}</div>
          <div class="text-xs text-gray-500">${esc(it.date)}${it.city?(" • "+esc(it.city)):""}</div>
          <div class="text-xs text-gray-500 mt-1">${esc(it.seat||"")}</div>
          <div class="mt-2 text-sm">Price: ${money(it.price)} • Qty: ${it.qty} • Avail: ${(it.remaining ?? it.qty)}</div>
        `;
        wrap.appendChild(div);
      }
    }

    async function checkSid(){
      const sid = document.getElementById("sidInput").value.trim();
      if(!sid) return;
      const r = await fetch(`${ORIGIN}/api/session-status?sid=${encodeURIComponent(sid)}`);
      const d = await r.json().catch(()=> ({}));
      const out = document.getElementById("sidResult");
      out.textContent = JSON.stringify(d, null, 2);
    }
    document.getElementById("checkSid")?.addEventListener("click", checkSid);

    /* ✅ NEW: local saved orders utilities */
    const FEP_ORDERS_KEY = "fep_orders_v1"; // [{ sid, savedAt }]
    function getOrders() { try { return JSON.parse(localStorage.getItem(FEP_ORDERS_KEY) || "[]"); } catch { return []; } }
    function saveOrders(list) { localStorage.setItem(FEP_ORDERS_KEY, JSON.stringify(list || [])); }
    function addOrderSid(sid) {
      if (!sid) return;
      const list = getOrders();
      if (!list.find(o => o.sid === sid)) {
        list.unshift({ sid, savedAt: Date.now() });
        saveOrders(list);
      }
    }
    async function fetchOrderStatus(sid) {
      const r = await fetch(`${ORIGIN}/api/session-status?sid=${encodeURIComponent(sid)}`);
      if (!r.ok) throw new Error(await r.text().catch(()=>"") || r.statusText);
      return r.json();
    }
    function fmtDeadline(deadlineEpochSec, nowEpochSec) {
      const remain = Math.max(0, deadlineEpochSec - nowEpochSec);
      const h = Math.floor(remain / 3600);
      const m = Math.floor((remain % 3600) / 60);
      const s = remain % 60;
      return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
    }

    /* ✅ NEW: render Orders in Seller Dashboard */
    async function renderOrders() {
      const wrap = document.getElementById("myOrders");
      const empty = document.getElementById("noOrders");
      if (!wrap) return;
      wrap.textContent = "";
      const list = getOrders();
      if (!list.length) { empty?.classList.remove("hidden"); return; }
      empty?.classList.add("hidden");

      for (const o of list) {
        const div = document.createElement("div");
        div.className = "rounded-2xl border border-gray-200 p-3 text-sm";
        div.innerHTML = `
          <div class="font-semibold break-all">SID: ${esc(o.sid)}</div>
          <div class="text-xs text-gray-500 mt-0.5">Saved ${new Date(o.savedAt).toLocaleString()}</div>
          <div class="mt-2" data-status>Loading…</div>
          <div class="mt-2 flex gap-2">
            <button class="rounded-xl bg-gray-900 text-white px-3 py-1" data-refresh>Refresh</button>
            <button class="rounded-xl bg-white ring-1 ring-gray-200 px-3 py-1" data-remove>Remove</button>
          </div>
        `;
        wrap.appendChild(div);

        const statusEl = div.querySelector("[data-status]");
        const refreshBtn = div.querySelector("[data-refresh]");
        const removeBtn = div.querySelector("[data-remove]");
        let timer = null;

        async function refreshOne() {
          statusEl.textContent = "Loading…";
          try {
            const d = await fetchOrderStatus(o.sid);
            if (timer) { clearInterval(timer); timer = null; }
            if (!d?.ok) { statusEl.textContent = "Unknown session"; return; }

            if (d.requiresCapture) {
              statusEl.innerHTML = `Status: ${esc(d.status)}<br>Escrow: requires_capture<br>`;
              if (d.deadline && d.now) {
                const span = document.createElement("span");
                span.className = "font-semibold";
                span.textContent = fmtDeadline(d.deadline, d.now);
                const line = document.createElement("div");
                line.innerHTML = "Auto-capture in ";
                line.appendChild(span);
                statusEl.appendChild(line);
                timer = setInterval(() => {
                  span.textContent = fmtDeadline(d.deadline, Math.floor(Date.now()/1000));
                }, 1000);
              }
            } else {
              statusEl.innerHTML = `Status: ${esc(d.status)}`;
            }
          } catch (e) { statusEl.textContent = "Failed to load"; }
        }

        refreshBtn.addEventListener("click", refreshOne);
        removeBtn.addEventListener("click", () => {
          saveOrders(getOrders().filter(x => x.sid !== o.sid));
          renderOrders();
        });
        refreshOne();
      }
    }
    document.getElementById("refreshOrders")?.addEventListener("click", renderOrders);

    function loadSellerPanel(){
      const p = new URLSearchParams(location.search);
      const acct = p.get("account"); const ob = p.get("onboarded");
      if (acct) {
        localStorage.setItem(FEP_ACCT_KEY, acct);
        const prof = getSellerProfile() || {};
        setSellerProfile({ email: prof.email || localStorage.getItem(FEP_SELLER_EMAIL_KEY) || "", connectAccountId: acct });
        history.replaceState({}, "", location.pathname);
      }
      loadStripeStatus();
      renderMyListings();
      renderOrders(); // ✅ NEW
    }

    /* ===========================
       Init
       =========================== */
    (function init(){
      gateCheck();
      applyFilters();
      document.getElementById("openSeller")?.classList.remove("hidden");
    })();
  </script>
</body>
</html>
