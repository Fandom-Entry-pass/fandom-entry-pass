name: Auto Release (Twice Daily)

on:
  schedule:
    - cron: "0 5,17 * * *" # 05:00 & 17:00 UTC (twice daily)
  workflow_dispatch:

jobs:
  run-cron:
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.FEP_APP_BASE_URL }}" ] || [ -z "${{ secrets.FEP_CRON_SECRET }}" ]; then
            echo "❌ Missing GitHub Secrets FEP_APP_BASE_URL or FEP_CRON_SECRET"
            exit 1
          fi

      name: Call auto-release endpoint
  env:
    APP_BASE: ${{ secrets.FEP_APP_BASE_URL }}
    CRON_KEY: ${{ secrets.FEP_CRON_SECRET }}
  run: |
    set -e
    URL="${APP_BASE%/}/api/cron-auto-release?key=${CRON_KEY}&maxOps=50"
    echo "GET $URL"
    HTTP_STATUS=$(curl -sS -L -w "%{http_code}" -o resp.json "$URL") || {
      echo "❌ curl failed to reach ${URL}"
      exit 1
    }
    echo "Status: $HTTP_STATUS"
    echo "Response:"; cat resp.json || true
    if ! grep -q '"ok": true' resp.json; then
      echo "❌ Endpoint returned ok:false (or missing)."
      exit 1
    fi
    echo "✅ Auto-release run succeeded."
